---
phase: 01-project-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - tsup.config.ts
  - vitest.config.ts
  - src/index.ts
  - tests/smoke.test.ts
autonomous: true
requirements:
  - CFG-05
  - DEV-01

must_haves:
  truths:
    - "Running `npm run build` from a fresh clone produces dist/index.js with no manual steps"
    - "Running `npm test` executes tests in a TypeScript-native ESM environment and all tests pass"
    - "Running `node dist/index.js` prints the version string without error"
    - "Importing any src module in a test file succeeds without ERR_MODULE_NOT_FOUND"
  artifacts:
    - path: "package.json"
      provides: "Project metadata, scripts, and dependency declarations"
      contains: "\"type\": \"module\""
    - path: "tsconfig.json"
      provides: "TypeScript compiler configuration for NodeNext ESM"
      contains: "\"module\": \"NodeNext\""
    - path: "tsup.config.ts"
      provides: "Bundle configuration for single-file CLI distributable"
      contains: "banner"
    - path: "vitest.config.ts"
      provides: "Test runner configuration"
      contains: "environment: 'node'"
    - path: "src/index.ts"
      provides: "CLI entry point stub"
      min_lines: 5
    - path: "tests/smoke.test.ts"
      provides: "ESM import chain smoke test"
      min_lines: 10
  key_links:
    - from: "package.json"
      to: "dist/index.js"
      via: "tsup build"
      pattern: "\"build\": \"tsup"
    - from: "tsconfig.json"
      to: "src/**/*.ts"
      via: "include array"
      pattern: "\"include\".*src"
    - from: "tests/smoke.test.ts"
      to: "src/index.js"
      via: "dynamic import"
      pattern: "import.*src/index\\.js"
---

<objective>
Bootstrap the Node.js ESM TypeScript project so that `npm run build` produces a runnable CLI binary and `npm test` passes in a TypeScript-native ESM environment from a fresh clone.

Purpose: Every subsequent phase depends on a stable, correctly configured TypeScript ESM build environment. Getting ESM + NodeNext + tsup + vitest aligned on day one prevents module resolution errors from silently breaking later phases.
Output: package.json with correct scripts and deps; tsconfig.json with NodeNext module resolution; tsup.config.ts producing a shebang-topped binary; vitest.config.ts; src/index.ts stub; passing smoke test.
</objective>

<execution_context>
@/Users/shubh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shubh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize project with ESM TypeScript toolchain</name>
  <files>package.json, tsconfig.json, tsup.config.ts, vitest.config.ts</files>
  <action>
Create the project root with the following files. The working directory is /Users/shubh/Repos/Github_Shubham/ops-pod-optimization.

**package.json** — Create with these exact fields:
```json
{
  "name": "ops-pod-opt",
  "version": "0.1.0",
  "description": "Kubernetes pod right-sizing analysis via Dynatrace v2 API",
  "type": "module",
  "engines": {
    "node": ">=20.0.0"
  },
  "bin": {
    "ops-pod-opt": "./dist/index.js"
  },
  "scripts": {
    "build": "tsup && chmod +x dist/index.js",
    "dev": "tsx src/index.ts",
    "test": "vitest run",
    "test:watch": "vitest",
    "typecheck": "tsc --noEmit"
  },
  "devDependencies": {},
  "dependencies": {}
}
```

Then install all dependencies in one command:
```bash
npm install -D typescript tsx tsup vitest @types/node @types/js-yaml
npm install js-yaml zod commander handlebars ora chalk date-fns
```

This installs current versions (typescript 5.x, tsup 8.x, vitest 4.x, tsx 4.x) plus all runtime deps needed across all future phases — install now to avoid version surprises later.

**tsconfig.json** — Create with NodeNext module resolution:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "lib": ["ES2022"],
    "outDir": "dist",
    "rootDir": "src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "declaration": false,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

CRITICAL: `"module": "NodeNext"` is required. Do NOT use `"module": "commonjs"` — it conflicts with `"type": "module"` in package.json.

**tsup.config.ts** — Create:
```typescript
import { defineConfig } from 'tsup';

export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm'],
  target: 'node20',
  bundle: true,
  minify: false,
  clean: true,
  banner: {
    js: '#!/usr/bin/env node',
  },
});
```

**vitest.config.ts** — Create:
```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
  },
});
```
  </action>
  <verify>
    <automated>cd /Users/shubh/Repos/Github_Shubham/ops-pod-optimization && node -e "const p = JSON.parse(require('fs').readFileSync('package.json','utf8')); console.assert(p.type==='module'); console.assert(p.scripts.build); console.assert(p.scripts.test); console.log('package.json OK')" && node -e "const t = JSON.parse(require('fs').readFileSync('tsconfig.json','utf8')); console.assert(t.compilerOptions.module==='NodeNext'); console.log('tsconfig.json OK')"</automated>
    <manual>Verify tsup.config.ts and vitest.config.ts exist in project root</manual>
  </verify>
  <done>package.json has "type": "module", tsconfig.json has "module": "NodeNext", tsup.config.ts and vitest.config.ts exist, node_modules populated.</done>
</task>

<task type="auto">
  <name>Task 2: Create entry point stub and smoke test, verify build and test pass</name>
  <files>src/index.ts, tests/smoke.test.ts</files>
  <action>
Create the source directory and entry point stub, then the smoke test. Run build and test to confirm the entire toolchain is wired correctly.

**src/index.ts** — Create with a pure module guard (no side effects on import — required for the smoke test to import it safely):
```typescript
// src/index.ts
// Phase 1 stub: prints version. Full CLI wired in Phase 9.
// Does NOT auto-execute on import — uses explicit main() guard.

const VERSION = '0.1.0';

export function main(): void {
  console.log(`ops-pod-opt v${VERSION}`);
  console.log('Run with --help for usage (available after Phase 9).');
}

// Only execute when run directly, not when imported by tests
const isMain = import.meta.url === `file://${process.argv[1]}`;
if (isMain) {
  main();
}
```

CRITICAL: The `isMain` guard prevents `main()` from firing when the smoke test imports the module dynamically.

**tests/smoke.test.ts** — Create:
```typescript
// tests/smoke.test.ts
// Verifies the ESM import chain works end-to-end.
// If any import fails with ERR_MODULE_NOT_FOUND, the ESM config is broken.
import { describe, it, expect } from 'vitest';

describe('build smoke test', () => {
  it('can import src/index.ts without resolution errors', async () => {
    const mod = await import('../src/index.js');
    expect(typeof mod.main).toBe('function');
  });

  it('main() function is callable', async () => {
    const { main } = await import('../src/index.js');
    // Should not throw
    expect(() => main()).not.toThrow();
  });
});
```

CRITICAL: The import path is `'../src/index.js'` (not `.ts`). This is mandatory for TypeScript ESM — `.js` extension refers to the compiled output file; TypeScript resolves it to the `.ts` source at compile time.

After creating both files, run:
```bash
cd /Users/shubh/Repos/Github_Shubham/ops-pod-optimization
npm run build
npm test
```

If `npm run build` fails with module resolution errors, check:
1. All imports in src/ use `.js` extensions
2. tsconfig.json has `"module": "NodeNext"`
3. package.json has `"type": "module"`

If `npm test` fails with "No test files found", verify the file is named `smoke.test.ts` (vitest looks for `*.test.ts`).
  </action>
  <verify>
    <automated>cd /Users/shubh/Repos/Github_Shubham/ops-pod-optimization && npm run build 2>&1 | tail -5 && npm test 2>&1 | tail -10</automated>
    <manual>Confirm dist/index.js exists and running `node dist/index.js` prints "ops-pod-opt v0.1.0"</manual>
  </verify>
  <done>`npm run build` exits 0 and produces dist/index.js; `npm test` exits 0 with all tests passing; `node dist/index.js` prints the version string.</done>
</task>

</tasks>

<verification>
Full phase verification commands:
```bash
cd /Users/shubh/Repos/Github_Shubham/ops-pod-optimization
# 1. Build succeeds
npm run build
# 2. Tests pass
npm test
# 3. Binary is executable and prints version
node dist/index.js
# 4. TypeScript has no errors
npm run typecheck
```
</verification>

<success_criteria>
1. `npm run build` exits 0 from a fresh state and produces `dist/index.js` with a shebang line
2. `npm test` exits 0 with the smoke test suite passing (2 tests)
3. `node dist/index.js` prints `ops-pod-opt v0.1.0`
4. `npm run typecheck` exits 0 with no TypeScript errors
5. `package.json` has `"type": "module"` and `tsconfig.json` has `"module": "NodeNext"`
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-foundation/01-01-SUMMARY.md` documenting:
- Exact dependency versions installed (from `npm list --depth=0`)
- Any deviations from the RESEARCH.md patterns and why
- Confirmation that ESM import chain works (smoke test output)
- Node.js version used (`node --version`)
</output>
